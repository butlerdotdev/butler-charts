{{/*
Copyright 2026 The Butler Authors.
SPDX-License-Identifier: Apache-2.0
*/}}
{{/*
Admin credentials secret - generates random password if not provided.
Uses lookup to preserve password across helm upgrades.

Contains two keys:
  - admin-password: The plaintext password (for env var injection)
  - password-hash: Empty initially, populated by server on startup with bcrypt hash

The butler-addons User CRD references this secret's password-hash key.
*/}}
{{- if and .Values.server.enabled .Values.server.auth.platform.enabled (not .Values.server.auth.platform.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "butler-console.fullname" . }}-admin
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "butler-console.labels" . | nindent 4 }}
    app.kubernetes.io/component: admin-credentials
  annotations:
    # Keep secret on helm uninstall to prevent accidental password loss
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{- /* Check if password is explicitly provided */ -}}
  {{- if .Values.server.auth.platform.adminPassword }}
  admin-password: {{ .Values.server.auth.platform.adminPassword | b64enc | quote }}
  {{- else }}
  {{- /* Look up existing secret to preserve password across upgrades */ -}}
  {{- $secretName := printf "%s-admin" (include "butler-console.fullname" .) }}
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace $secretName) | default dict }}
  {{- $secretData := (get $secretObj "data") | default dict }}
  {{- $existingPassword := get $secretData "admin-password" }}
  {{- if $existingPassword }}
  {{- /* Reuse existing password */ -}}
  admin-password: {{ $existingPassword | quote }}
  {{- else }}
  {{- /* Generate new random password (24 chars alphanumeric) */ -}}
  admin-password: {{ randAlphaNum 24 | b64enc | quote }}
  {{- end }}
  {{- end }}
  {{- /* password-hash is populated by the server on startup */ -}}
  {{- /* Preserve existing hash across upgrades if it exists */ -}}
  {{- $secretName := printf "%s-admin" (include "butler-console.fullname" .) }}
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace $secretName) | default dict }}
  {{- $secretData := (get $secretObj "data") | default dict }}
  {{- $existingHash := get $secretData "password-hash" }}
  {{- if $existingHash }}
  password-hash: {{ $existingHash | quote }}
  {{- else }}
  password-hash: ""
  {{- end }}
{{- end }}
