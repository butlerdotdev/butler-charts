{{/*
Copyright 2026 The Butler Authors.
SPDX-License-Identifier: Apache-2.0
*/}}
{{- if and .Values.server.enabled .Values.server.auth.platform.enabled (not .Values.server.auth.platform.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "butler-console.fullname" . }}-admin
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "butler-console.labels" . | nindent 4 }}
    app.kubernetes.io/component: admin-credentials
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{- /* Look up existing secret to preserve values across upgrades */ -}}
  {{- $secretName := printf "%s-admin" (include "butler-console.fullname" .) -}}
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace $secretName) | default dict -}}
  {{- $secretData := (get $secretObj "data") | default dict -}}
  {{- /* admin-password */ -}}
  {{- if .Values.server.auth.platform.adminPassword }}
  admin-password: {{ .Values.server.auth.platform.adminPassword | b64enc | quote }}
  {{- else if (get $secretData "admin-password") }}
  admin-password: {{ get $secretData "admin-password" | quote }}
  {{- else }}
  admin-password: {{ randAlphaNum 24 | b64enc | quote }}
  {{- end }}
  {{- /* password-hash - populated by server on startup */ -}}
  {{- if (get $secretData "password-hash") }}
  password-hash: {{ get $secretData "password-hash" | quote }}
  {{- else }}
  password-hash: {{ "" | b64enc | quote }}
  {{- end }}
{{- end }}
